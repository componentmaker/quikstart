apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: kafka-controller
  namespace: kafka
  labels:
    app: kafka
    component: controller
spec:
  serviceName: kafka-controller-headless
  replicas: 3
  selector:
    matchLabels:
      app: kafka
      component: controller
  template:
    metadata:
      labels:
        app: kafka
        component: controller
    spec:
      securityContext:
        fsGroup: 0
      initContainers:
        - name: config-initializer
          image: busybox:1.36
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              while [ ! -f /config-template/server.properties ]; do
                echo "Waiting for ConfigMap file to be mounted..."
                sleep 1
              done
              echo "ConfigMap mounted. Proceeding with initialization."

              mkdir -p /processed-config
              ORDINAL=${HOSTNAME##*-}
              echo "Initializing config for controller node: $ORDINAL"
              sed "s/CONTROLLER_ID_PLACEHOLDER/$ORDINAL/g" /config-template/server.properties > /processed-config/server.properties
          volumeMounts:
            - name: config-template
              mountPath: /config-template
            - name: processed-config
              mountPath: /processed-config
        - name: prepare-storage
          image: apache/kafka:3.9.1
          command: ["/bin/sh", "-c"]
          args:
            - |
              set -e
              TEMP_PROPS_FILE="/tmp/kraft-storage.properties"
              ORDINAL=${HOSTNAME##*-}
              
              cat <<EOF > "$TEMP_PROPS_FILE"
              process.roles=controller
              node.id=$ORDINAL
              log.dirs=/kafka/controller-logs
              controller.listener.names=CONTROLLER
              listeners=CONTROLLER://:9093
              controller.quorum.voters=0@kafka-controller-0.kafka-controller-headless.kafka.svc.cluster.local:9093,1@kafka-controller-1.kafka-controller-headless.kafka.svc.cluster.local:9093,2@kafka-controller-2.kafka-controller-headless.kafka.svc.cluster.local:9093
              EOF

              echo "Formatting storage directory for controller node: $ORDINAL..."
              /opt/kafka/bin/kafka-storage.sh format \
                -t "$KAFKA_CLUSTER_ID" \
                -c "$TEMP_PROPS_FILE" \
                --ignore-formatted
          env:
            - name: KAFKA_CLUSTER_ID
              value: "io9BKK6KRpSRz2uIOTva-g"
          volumeMounts:
            - name: controller-logs
              mountPath: /kafka/controller-logs
      containers:
        - name: kafka-controller
          image: apache/kafka:3.9.1
          command:
            - "/opt/kafka/bin/kafka-server-start.sh"
            - "/processed-config/server.properties"
          ports:
            - containerPort: 9093
              name: controller
          env:
            - name: KAFKA_HEAP_OPTS
              value: "-Xmx1G -Xms1G"
          volumeMounts:
            - name: controller-logs
              mountPath: /kafka/controller-logs
            - name: processed-config
              mountPath: /processed-config
            - name: controller-secrets
              mountPath: /etc/kafka/secrets
              readOnly: true
      volumes:
        - name: config-template
          configMap:
            name: kafka-controller-config
        - name: processed-config
          emptyDir: {}
        - name: controller-secrets
          secret:
            secretName: kafka-controller-secrets
  volumeClaimTemplates:
    - metadata:
        name: controller-logs
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 5Gi
